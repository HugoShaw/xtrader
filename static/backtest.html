<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>A-Share Backtest</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    label { font-size: 12px; color:#444; display:block; margin-bottom: 4px; }
    input, select { padding:8px; border:1px solid #ccc; border-radius:8px; }
    button { padding:10px 14px; border:0; border-radius:10px; cursor:pointer; }
    #msg { margin-top: 10px; color:#555; font-size: 12px; }
    iframe { width:100%; height: 760px; border: 1px solid #ddd; border-radius: 10px; margin-top: 14px; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin-top: 12px; }
    pre { white-space: pre-wrap; word-break: break-word; font-size: 12px; }
  </style>
</head>
<body>
  <h2>A-Share Backtest (AkShare + vectorbt)</h2>

  <div class="row">
    <div>
      <label>Symbol (6 digits)</label>
      <input id="symbol" value="600519"/>
    </div>
    <div>
      <label>Start (YYYY-MM-DD HH:MM:SS)</label>
      <input id="start" value="2025-12-01 09:30:00"/>
    </div>
    <div>
      <label>End (YYYY-MM-DD HH:MM:SS)</label>
      <input id="end" value="2025-12-31 15:00:00"/>
    </div>
    <div>
      <label>Freq</label>
      <select id="freq">
        <option value="1">1min</option>
        <option value="5" selected>5min</option>
        <option value="15">15min</option>
        <option value="30">30min</option>
        <option value="60">60min</option>
      </select>
    </div>
    <div>
      <label>Fixed Notional</label>
      <input id="notional" value="200"/>
    </div>
    <div>
      <label>Max Trades/Day</label>
      <input id="maxTrades" value="10"/>
    </div>

    <button onclick="runBacktest()">Run</button>
    <button onclick="openReport()">Open Report</button>
  </div>

  <div id="msg"></div>

  <div class="card">
    <b>JSON summary</b>
    <pre id="json"></pre>
  </div>

  <iframe id="report" title="report"></iframe>

<script>
  function qs() {
    const symbol = document.getElementById('symbol').value.trim();
    const start = document.getElementById('start').value.trim();
    const end = document.getElementById('end').value.trim();
    const freq = document.getElementById('freq').value;
    const fixed_notional = document.getElementById('notional').value.trim();
    const max_trades_per_day = document.getElementById('maxTrades').value.trim();

    const p = new URLSearchParams({symbol, start, end, freq, fixed_notional, max_trades_per_day});
    return p.toString();
  }

  async function runBacktest() {
    document.getElementById('msg').innerText = "Running backtest...";
    document.getElementById('json').innerText = "";
    document.getElementById('report').src = "";

    const url = "/api/backtest/run?" + qs();
    const resp = await fetch(url);
    const data = await resp.json();

    if (!resp.ok) {
      document.getElementById('msg').innerText = "Error: " + (data.detail || resp.statusText);
      return;
    }
    document.getElementById('msg').innerText = "Done.";
    // show only part of JSON to avoid huge output
    const slim = {
      symbol: data.symbol,
      freq: data.freq,
      start: data.start,
      end: data.end,
      note: data.note,
      stats: data.stats
    };
    document.getElementById('json').innerText = JSON.stringify(slim, null, 2);
  }

  function openReport() {
    document.getElementById('msg').innerText = "Loading report...";
    document.getElementById('report').src = "/api/backtest/report?" + qs();
  }
</script>
</body>
</html>
